## PR Review - Ruby/Rails

Pull Request ã®ä½“ç³»çš„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚³ãƒ¼ãƒ‰å“è³ªã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¥å…¨æ€§ã‚’ç¢ºä¿ã—ã¾ã™ã€‚

### ä½¿ã„æ–¹

```bash
# PR ã®åŒ…æ‹¬çš„ãƒ¬ãƒ“ãƒ¥ãƒ¼
gh pr view 123 --comments
ã€Œã“ã® PR ã‚’ä½“ç³»çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã‚³ãƒ¼ãƒ‰å“è³ªã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¦³ç‚¹ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã—ã¦ãã ã•ã„ã€

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹åŒ–ãƒ¬ãƒ“ãƒ¥ãƒ¼
gh pr diff 123
ã€ŒRailsã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã¨è„†å¼±æ€§ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¦³ç‚¹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
gh pr checkout 123 && find . -name "*.rb" | head -10
ã€ŒMVCã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ã€Rails Way ã®è¦³ç‚¹ã‹ã‚‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€
```

### åŸºæœ¬ä¾‹

```bash
# ã‚³ãƒ¼ãƒ‰å“è³ªã®æ•°å€¤çš„è©•ä¾¡
find . -name "*.rb" -exec wc -l {} + | sort -rn | head -5
"ãƒ¡ã‚½ãƒƒãƒ‰ã®è¤‡é›‘åº¦ã€ã‚¯ãƒ©ã‚¹ã‚µã‚¤ã‚ºã€é‡è¤‡åº¦ã‚’è©•ä¾¡ã—ã¦æ”¹å–„ç‚¹ã‚’æŒ‡æ‘˜ã—ã¦ãã ã•ã„"

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
grep -r "password\|secret\|token\|api_key" . --include="*.rb" | head -10
"æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã®ãƒªã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„"

# Railsè¦ç´„é•åã®æ¤œå‡º
grep -r "User\.find" . --include="*.rb"
"N+1ã‚¯ã‚¨ãƒªã€SQLæ³¨å…¥ã€ActiveRecord ã®ä¸é©åˆ‡ãªä½¿ç”¨ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„"

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é•åã®æ¤œå‡º
find . -name "*.rb" -exec grep -l "require.*\.\./" {} \;
"MVCã®è²¬å‹™åˆ†é›¢ã€å¾ªç’°ä¾å­˜ã€çµåˆåº¦ã®å•é¡Œã‚’è©•ä¾¡ã—ã¦ãã ã•ã„"
```

### ã‚³ãƒ¡ãƒ³ãƒˆåˆ†é¡ä½“ç³»

```
ğŸ”´ critical.must: è‡´å‘½çš„å•é¡Œ
â”œâ”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ï¼ˆSQLæ³¨å…¥ã€XSSã€CSRFï¼‰
â”œâ”€ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§å•é¡Œ
â””â”€ ã‚·ã‚¹ãƒ†ãƒ éšœå®³ãƒªã‚¹ã‚¯

ğŸŸ¡ high.imo: é«˜å„ªå…ˆåº¦æ”¹å–„
â”œâ”€ æ©Ÿèƒ½ä¸å…¨ã®ãƒªã‚¹ã‚¯
â”œâ”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œï¼ˆN+1ã‚¯ã‚¨ãƒªï¼‰
â””â”€ ä¿å®ˆæ€§ã®å¤§å¹…ä½ä¸‹

ğŸŸ¢ medium.imo: ä¸­å„ªå…ˆåº¦æ”¹å–„
â”œâ”€ å¯èª­æ€§ã®å‘ä¸Š
â”œâ”€ Railsè¦ç´„æº–æ‹ 
â””â”€ ãƒ†ã‚¹ãƒˆå“è³ªå‘ä¸Š

ğŸŸ¢ low.nits: è»½å¾®ãªæŒ‡æ‘˜
â”œâ”€ Rubocopã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€
â”œâ”€ ã‚¿ã‚¤ãƒä¿®æ­£
â””â”€ ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 

ğŸ”µ info.q: è³ªå•ãƒ»æƒ…å ±æä¾›
â”œâ”€ å®Ÿè£…æ„å›³ã®ç¢ºèª
â”œâ”€ è¨­è¨ˆåˆ¤æ–­ã®èƒŒæ™¯
â””â”€ Rails ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®å…±æœ‰
```

### ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹

#### 1. ã‚³ãƒ¼ãƒ‰æ­£ç¢ºæ€§

- **ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼**: å¢ƒç•Œå€¤ã€nil ãƒã‚§ãƒƒã‚¯ã€ä¾‹å¤–å‡¦ç†
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: å‹å®‰å…¨æ€§ã€ActiveRecord ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: rescue ã®é©åˆ‡ãªä½¿ç”¨ã€ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–

#### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **èªè¨¼ãƒ»èªå¯**: Devise, CanCan ã®é©åˆ‡ãªä½¿ç”¨
- **Strong Parameters**: é©åˆ‡ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨±å¯
- **SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**: ç”ŸSQLã®å›é¿ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª
- **XSSå¯¾ç­–**: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³
- **æ©Ÿå¯†æƒ…å ±**: credentials.yml.enc ã®ä½¿ç”¨ã€ãƒ­ã‚°å‡ºåŠ›ç¦æ­¢

#### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- **N+1ã‚¯ã‚¨ãƒª**: includes, joins ã®é©åˆ‡ãªä½¿ç”¨
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–ã€é‡ã„ã‚¯ã‚¨ãƒªã®å›é¿
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: Rails.cache, fragment cache ã®æ´»ç”¨
- **ãƒ¡ãƒ¢ãƒªåŠ¹ç‡**: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ™‚ã®find_eachä½¿ç”¨

#### 4. Rails ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

- **MVCåˆ†é›¢**: Controller ã®è²¬å‹™ã€Fat Model å›é¿
- **Service Object**: è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢
- **ActiveRecord**: é©åˆ‡ãªé–¢é€£å®šç¾©ã€scope ã®æ´»ç”¨
- **Rails Way**: è¦ç´„ã«å¾“ã£ãŸå®Ÿè£…ã€gem ã®é©åˆ‡ãªä½¿ç”¨

#### 5. Ruby ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«

- **ãƒ¡ã‚½ãƒƒãƒ‰è¨­è¨ˆ**: å˜ä¸€è²¬ä»»ã€é©åˆ‡ãªé•·ã•
- **ã‚¯ãƒ©ã‚¹è¨­è¨ˆ**: SOLIDåŸå‰‡ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–
- **ä¾‹å¤–å‡¦ç†**: é©åˆ‡ãªrescueã€ensure ã®ä½¿ç”¨
- **Rubocop**: ã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ã‚¤ãƒ‰æº–æ‹ 

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ãƒ­ãƒ¼

1. **äº‹å‰ç¢ºèª**: PR æƒ…å ±ã€å¤‰æ›´å·®åˆ†ã€é–¢é€£ Issueã€Railsãƒãƒ¼ã‚¸ãƒ§ãƒ³
2. **ä½“ç³»çš„ãƒã‚§ãƒƒã‚¯**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ â†’ æ­£ç¢ºæ€§ â†’ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ â†’ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ â†’ ã‚¹ã‚¿ã‚¤ãƒ«
3. **å»ºè¨­çš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: å…·ä½“çš„ãªæ”¹å–„æ¡ˆã¨Ruby/Railsã‚³ãƒ¼ãƒ‰ä¾‹
4. **ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—**: ä¿®æ­£ç¢ºèªã€RSpecå®Ÿè¡Œã€æœ€çµ‚æ‰¿èª

### åŠ¹æœçš„ãªã‚³ãƒ¡ãƒ³ãƒˆä¾‹

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ**

```markdown
**critical.must.** Strong Parameters ãŒä¸é©åˆ‡ã§ã™

```ruby
# ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ï¼ˆå±é™ºï¼‰
def user_params
  params[:user]
end

# ä¿®æ­£æ¡ˆ
def user_params
  params.require(:user).permit(:name, :email, :role)
end
```

Mass Assignment æ”»æ’ƒã‚’é˜²ããŸã‚ã€æ˜ç¤ºçš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨±å¯ãŒå¿…é ˆã§ã™ã€‚
```

**N+1ã‚¯ã‚¨ãƒªå•é¡Œ**
```markdown
**high.imo.** N+1ã‚¯ã‚¨ãƒªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã™

```ruby
# å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
@users.each { |user| user.posts.count }

# æ”¹å–„æ¡ˆ: Eager Loading
@users = User.includes(:posts)
@users.each { |user| user.posts.size }
```

ã‚¯ã‚¨ãƒªæ•°ã‚’å¤§å¹…ã«å‰Šæ¸›ã§ãã¾ã™ã€‚
```

**Rails ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é•å**
```markdown
**high.must.** ControllerãŒè‚¥å¤§åŒ–ã—ã¦ã„ã¾ã™

```ruby
# æ”¹å–„æ¡ˆ: Service Object ã®å°å…¥
class UserRegistrationService
  def initialize(user_params)
    @user_params = user_params
  end

  def call
    user = User.new(@user_params)
    if user.save
      UserMailer.welcome_email(user).deliver_later
      # ãã®ä»–ã®å‡¦ç†...
    end
    user
  end
end

# Controller
def create
  @user = UserRegistrationService.new(user_params).call
  # ...
end
```

ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’Serviceã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åˆ†é›¢ã—ã¦ãã ã•ã„ã€‚
```

**Ruby ã‚¹ã‚¿ã‚¤ãƒ«å•é¡Œ**
```markdown
**medium.imo.** Rubyã‚‰ã—ã„æ›¸ãæ–¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“

```ruby
# ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰
if !user.nil? && user.active == true
  # ...
end

# æ”¹å–„æ¡ˆ
if user&.active?
  # ...
end
```

å®‰å…¨ãªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ¼”ç®—å­ã¨predicateãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
```

**ãƒ†ã‚¹ãƒˆé–¢é€£**
```markdown
**medium.imo.** RSpecã®ãƒ†ã‚¹ãƒˆãŒä¸ååˆ†ã§ã™

```ruby
# è¿½åŠ æ¨å¥¨ãƒ†ã‚¹ãƒˆ
describe 'POST #create' do
  context 'with valid parameters' do
    it 'creates a new user' do
      expect {
        post :create, params: { user: valid_attributes }
      }.to change(User, :count).by(1)
    end

    it 'sends welcome email' do
      expect(UserMailer).to receive(:welcome_email)
      post :create, params: { user: valid_attributes }
    end
  end

  context 'with invalid parameters' do
    it 'does not create a user' do
      expect {
        post :create, params: { user: invalid_attributes }
      }.not_to change(User, :count)
    end
  end
end
```

æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã®ä¸¡æ–¹ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
```

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ**
```markdown
**high.imo.** ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä¸è¶³ã—ã¦ã„ã¾ã™

```ruby
# db/migrate/xxx_add_index_to_users.rb
class AddIndexToUsers < ActiveRecord::Migration[7.0]
  def change
    add_index :users, :email, unique: true
    add_index :posts, [:user_id, :created_at]
  end
end
```

æ¤œç´¢ã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
```

### Railsç‰¹æœ‰ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

#### Gemfile & Dependencies
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šå•é¡Œã®ã‚ã‚‹gemã®ä½¿ç”¨
- ä¸è¦ãªgemã®è¿½åŠ 
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šã®å¦¥å½“æ€§

#### Routes
- RESTfulè¨­è¨ˆã¸ã®æº–æ‹ 
- ãƒã‚¹ãƒˆãŒæ·±ã™ãã‚‹routes
- ä¸è¦ãªroutesã®å®šç¾©

#### Models
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®é©åˆ‡æ€§
- é–¢é€£ï¼ˆassociationï¼‰ã®æ­£ç¢ºæ€§
- scopeã®é©åˆ‡ãªä½¿ç”¨
- callbackã®ä¹±ç”¨

#### Controllers
- before_actionã®é©åˆ‡ãªä½¿ç”¨
- è²¬å‹™ã®åˆ†é›¢
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ç¢ºèª

#### Views
- HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã®ç¢ºèª
- ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ«åŒ–ã®é©åˆ‡æ€§
- ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã®ä½¿ç”¨

### æ³¨æ„äº‹é …

- **Rails Way**: Rails ã®è¦ç´„ã¨å“²å­¦ã«æº–æ‹ ã—ãŸå®Ÿè£…ã‚’æ¨å¥¨
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Railsç‰¹æœ‰ã®è„†å¼±æ€§ï¼ˆCSRFã€SQLæ³¨å…¥ç­‰ï¼‰ã«æ³¨æ„
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ActiveRecordã®ç‰¹æ€§ã‚’ç†è§£ã—ãŸæœ€é©åŒ–
- **ãƒ†ã‚¹ãƒˆ**: RSpec/Minitestã§ã®é©åˆ‡ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
- **ç¶™ç¶šæ”¹å–„**: Rubocopã€Brakemanç­‰ã®é™çš„è§£æãƒ„ãƒ¼ãƒ«ã®æ´»ç”¨
